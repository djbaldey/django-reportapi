var TIMEOUT_PROGRESS=1000,SERVER_TZ_OFFSET=(window.SERVER_TZ_OFFSET!=undefined)?window.SERVER_TZ_OFFSET:-180;window.TEMPLATES={};_.mixin(_.str.exports());delay=(function(){var a=0;return function(c,b){if(DEBUG){console.log("function:delay "+b)}clearTimeout(a);a=setTimeout(c,b)}})();function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){if(DEBUG){console.log("function:handlerShowAlert")}b=b||5000;console.log(c);if(!a){a="alert-danger"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"reportapi.get_scheme"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON(a),language:window.LANGUAGE_CODE},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-danger")}}}).done(function(h,g,j){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){var k=function(){var l=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(l)};if(h.message){handlerShowAlert(h.message,"alert-danger",k)}else{k()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-danger");clearInterval(window.REPORT.process);window.REPORT.process=undefined;$(".progress .progress-bar").removeClass("progress-striped active");handlerSetProgress(0)}else{if(DEBUG){var i=new Object;$.extend(true,i,h.data);console.log($.toJSON(h.message))}return f(h,g,j)}}});return e}function handlerCreateReport(c){if(DEBUG){console.log("function:handlerCreateReport")}$(".action-create-report, .action-recreate-report, .action-preview, .action-remove").attr("disabled","disabled");$("#view-document-place").hide();window.REPORT.id=null;window.REPORT.process_filters={};$.each(window.REPORT.filters,function(e,f){if(f.condition||f.value!=null){window.REPORT.process_filters[f.name]={condition:f.condition,value:f.value}}});var b={method:"reportapi.document_create",section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,force:c},a=function(f,e,g){};var d=jsonAPI(b,a,null,false,window.REPORT.timeout);handlerStartProgress();return d}function handlerCheckProcess(){if(DEBUG){console.log("function:handlerCheckProcess")}var b={method:"reportapi.document_info",id:window.REPORT.id||null,section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,};var a=function(g,e,i){var h=$(".progress .progress-bar"),d=Number(h.attr("aria-valuemax")),f=Number(h.attr("aria-valuenow"));window.REPORT.id=g.data.id;window.REPORT.timeout=g.data.timeout;if(g.data.end){clearInterval(window.REPORT.process);window.REPORT.process=undefined;handlerSetProgress(d);$(".action-preview").attr("onclick","handlerShowDocument('"+g.data.url+"', 'document-"+g.data.id+"')").prop("disabled",false).removeAttr("disabled");if(g.data.error){$(".action-preview").removeClass("btn-default btn-success").addClass("btn-warning").find(".fa").removeClass("fa-search").addClass("fa-bug")}else{$(".action-preview").removeClass("btn-warning").addClass("btn-default").find(".fa").removeClass("fa-bug").addClass("fa-search")}if(g.data.has_remove){$(".action-remove").attr("onclick","handlerRemoveDocument("+g.data.id+")").prop("disabled",false).removeAttr("disabled")}else{$(".action-remove").removeAttr("onclick").prop("disabled",true).attr("disabled","disabled")}h.removeClass("progress-striped active");$(".action-recreate-report").prop("disabled",false).removeAttr("disabled");if(window.REPORT.create_force){$(".action-create-report:visible").hide();$(".action-recreate-report:hidden").show()}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}}else{if(f>=d){h.addClass("progress-striped active")}else{console.log(TIMEOUT_PROGRESS+f);handlerSetProgress(TIMEOUT_PROGRESS+f)}}};var c=jsonAPI(b,a);return c}function handlerStartProgress(){if(DEBUG){console.log("function:handlerStartProgress")}$(".action-create-report").prop("disabled",true);$(".progress .progress-bar").attr("aria-valuemax",window.REPORT.timeout||TIMEOUT_PROGRESS).attr("aria-valuenow",0).css("width","0%");window.REPORT.process=setInterval(function(){handlerCheckProcess()},window.TIMEOUT_PROGRESS)}function handlerRemoveDocument(d,b){if(DEBUG){console.log("function:handlerRemoveDocument")}if(d){var a={method:"reportapi.document_delete",id:d,},c=function(){$("#div-document-"+d).remove();$("#view-document-place").hide();if(b){window.location.reload()}else{handlerAfterChanges()}};new jsonAPI(a,c)}}function eventCreateReport(a){if(DEBUG){console.log("function:eventCreateReport")}handlerCreateReport();a.preventDefault()}function eventRecreateReport(a){if(DEBUG){console.log("function:eventRecreateReport")}handlerCreateReport(true);a.preventDefault()}function eventRemoveDocument(a){if(DEBUG){console.log("function:eventRemoveDocument")}var b=null;handlerRemoveDocument(b);a.preventDefault()}function handlerSetSelectizers(b){if(DEBUG){console.log("function:handlerSetSelectizers")}var b=b||$("body");$.each(b.find('select[data-type="object"]'),function(d,c){if(c.name){var e=window.REPORT.filters[c.name],f=e.unicode_key||"__unicode__";$(c).selectize({valueField:"pk",labelField:f,searchField:e.fields_search||f,create:false,options:e.options,maxItems:(e.condition=="range")?2:undefined,render:{option:function(h,g){return'<div><span class="pull-right"> #'+g(h.pk)+"</span><span>"+g(h[f])+"</span></div>"}},load:function(i,k){if(!i.length){return k()}if(e.search_on_date){var g=moment(i);if(g.invalidAt()>-1||i.length<10){return k()}}var h={method:"reportapi.object_search",section:window.REPORT.section||null,name:window.REPORT.name,filter_name:e.name,query:i,},j=function(l){k(l.data.object_list)};new jsonAPI(h,j)},onChange:function(g){if(e.condition=="range"&&g.length!=2){e.value=null}else{e.value=(g=="")?null:g}handlerAfterChanges()},onClear:function(){e.value=null;handlerAfterChanges()}})}});var a=b.find('select[data-type="choice"],                      select[data-type="month"],                      select[data-type="weekday"],                      select[data-type="period"]');$.each(a,function(d,c){if(c.name){var e=window.REPORT.filters[c.name];$(c).selectize({options:e.options,valueField:"value",labelField:"label",searchField:"label",create:false,maxItems:(e.condition=="range")?2:undefined,onChange:function(f){if(e.condition=="range"&&f.length!=2){e.value=null}else{e.value=(f=="")?null:f}handlerAfterChanges()},onClear:function(){e.value=null;handlerAfterChanges()}})}})}function handlerMaskInputs(a){if(DEBUG){console.log("function:handlerMaskInputs")}var a=a||$("body");$.mask.definitions["1"]="[0-1]";$.mask.definitions["2"]="[0-2]";$.mask.definitions["3"]="[0-3]";$.mask.definitions["5"]="[0-5]";$.each(a.find("[data-mask]"),function(c,d){var b=$(d),e=$(d).data();b.mask(e.mask,{completed:function(){var f=REPORT.filters[this.context.name];f.value=this.val();if(f.condition=="range"){f.value=f.value.split(RANGE_SPLIT)}if(DEBUG){console.log("function:handlerMaskInputs:completed; filter="+f.value)}}})});return true}function handlerCheckRequiredValue(){if(DEBUG){console.log("function:handlerCheckRequiredValue")}var a=true;$.each(REPORT.filters,function(b,c){if((c.required)&&(c.value===null||c.value===undefined)){a=false}});if(a){$(".action-create-report").prop("disabled",false).removeAttr("disabled")}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}return a}function handlerAfterChanges(){if(DEBUG){console.log("function:handlerAfterChanges")}if(window.REPORT.process){clearInterval(window.REPORT.process);window.REPORT.id=null;window.REPORT.process=null}handlerSetProgress(0);$(".action-create-report, .action-preview, .action-remove").attr("disabled","disabled");$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();handlerCheckRequiredValue()}function eventChangeValue(b){if(DEBUG){console.log("function:eventChangeValue")}var c=this.value,a=REPORT.filters[this.name];if(this.type=="radio"){a.value=(c=="true")?true:(c=="false")?false:null}else{if($(this).attr("data-mask")!==undefined&&c!=a.value){a.value=null}else{a.value=c||null}}handlerAfterChanges()}function eventConditionChange(e){if(DEBUG){console.log("function:eventConditionChange")}var d=REPORT.filters[$(this).data()["name"]],c=d.condition,a=d.value;d.condition=this.value||null;if(!d.condition||d.type in {object:0,choice:0,month:0,weekday:0,period:0}){d.value=null}else{if(d.condition in {isnull:0,empty:0}){d.value=true}else{if(d.condition in {range:0,"in":0}){if($.type(a)!="array"){if(a!=null){d.value=(d.condition=="range")?[a,a]:[a]}else{if(d.default_value!=undefined){d.value=[d.default_value,d.default_value]}}}else{if(c=="in"&&d.condition=="range"){d.value=a.slice(0,2);if(d.value.length<2){d.value[1]=d.value[0]}}}}else{if(c in {range:0,"in":0}){d.value=a[0]}else{if((a==null)&&(d.default_value!=undefined)){d.value=d.default_value}}}}}var b=TEMPLATES.filter({data:d});$("#valuebox-"+d.name).html(b);handlerSetSelectizers($("#valuebox-"+d.name));handlerMaskInputs($("#valuebox-"+d.name));handlerAfterChanges();return true}function keyDownIsControl(a){if(DEBUG){console.log("function:keyDownIsControl")}if((a.which==8)||(a.which==9)||(a.which==13)||(a.which==27)||(a.which>=33&&a.which<=46)||(a.which>=112&&a.which<=145)){return true}return false}function eventKeyDownOnDateTime(b){if(DEBUG){console.log("function:eventKeyDownOnDateTime")}var a=function(c){value=c.target.value||""};if(keyDownIsControl(b)){return true}else{if(b.which>=48&&b.which<=57){a(b);return true}}return false}function eventKeyDownOnNumber(a){var b=function(c){value=c.target.value||"";if(value.length<1){c.target.value="0."}else{if(value.indexOf(".")<0){c.target.value=c.target.value+"."}}};if((a.which>=48&&a.which<=57)||keyDownIsControl(a)){return true}else{if(a.which==188||a.which==190){b(a);return false}}return false}function dateToArray(b){if(DEBUG){console.log("function:dateToArray")}var a=function(c){if(c>9){return""+c}return"0"+c};return[""+(1900+b.getYear()),"-",a(b.getMonth()),"-",a(b.getDate())," ",a(b.getHours()),":",a(b.getMinutes()),":",a(b.getSeconds())]}function handlerMagicSet(c,b,e){if(DEBUG){console.log("function:handlerMagicSet",c.name)}var d,a=null;if(c.type=="datetime"){if(c.withseconds){d=b.join();if(e){a=e.join()}}else{d=b.slice(0,9).join();if(e){a=e.slice(0,9).join()}}}else{if(c.type=="date"){d=b.slice(0,5).join();if(e){a=e.slice(0,5).join()}}else{if(c.type=="time"){if(c.withseconds){d=b.slice(6).join();if(e){a=e.slice(6).join()}}else{d=b.slice(6,9).join();if(e){a=e.slice(6,9).join()}}}}}if(c.condition=="range"){c.value=[d,a||d]}else{c.value=d}if(c.condition=="range"){$("#value-"+c.name).val(c.value[0]+RANGE_SPLIT+c.value[1])}else{$("#value-"+c.name).val(c.value)}handlerSetSelectizers($("#valuebox-"+c.name));handlerMaskInputs($("#valuebox-"+c.name));handlerAfterChanges()}function handlerMagicNow(a){if(DEBUG){console.log("function:handlerMagicNow",a.name)}handlerMagicSet(a,dateToArray(new Date()))}function handlerSetProgress(b){if(DEBUG){console.log("function:handlerSetProgress")}var d=$(".progress .progress-bar"),a=Number(d.attr("aria-valuemax"))||100,b=b||0,c=(b/a)*100;c=c>100?100:c;d.attr("aria-valuenow",b).css("width",c+"%")}function handlerShowDocument(a,c,b){if(DEBUG){console.log("function:handlerShowDocument")}if(b){var e=window.open(a,c,"height=500,width=800,resizable=yes,scrollbars=yes");e.focus()}else{var f=$("#view-document-place"),d='<iframe class="embed-responsive-item" src="'+a+'" allowfullscreen webkitallowfullscreen></iframe>';if(f.size()==0){$("#view-"+c).toggle();$("#view-"+c+":visible .embed-responsive").html(d)}else{f.show().find(".embed-responsive").html(d)}}}function handlerShowAdditionalFilters(){if(DEBUG){console.log("function:handlerShowAdditionalFilters")}$(".additional-filter").show();$(".action-hide-additional").show();$(".action-show-additional").hide();return true}function handlerHideAdditionalFilters(){if(DEBUG){console.log("function:handlerHideAdditionalFilters")}$(".additional-filter").hide();$(".action-hide-additional").hide();$(".action-show-additional").show();return true}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.filter=_.template($("#underscore-filter").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("change",'select[id^="condition-"]',eventConditionChange);$("body").on("keydown",'input[data-validate="number"]',eventKeyDownOnNumber);$("body").on("change",'input[id^="value-"]',eventChangeValue);$("body").on("click",".action-hide-additional",handlerHideAdditionalFilters);$("body").on("click",".action-show-additional",handlerShowAdditionalFilters);$("body").on("click",".action-create-report",eventCreateReport);$("body").on("click",".action-recreate-report",eventRecreateReport);return true}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("alert").alert();a(".dropdown-toggle").dropdown();handlerBindinds();handlerMaskInputs();handlerHideAdditionalFilters()});