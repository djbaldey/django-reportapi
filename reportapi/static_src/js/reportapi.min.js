var TIMEOUT_PROGRESS=1000,SERVER_TZ_OFFSET=window.SERVER_TZ_OFFSET||-240;window.TEMPLATES={};_.mixin(_.str.exports());function isEmpty(b){for(var a in b){return false}return true}delay=(function(){var a=0;return function(c,b){if(DEBUG){console.log("function:delay "+b)}clearTimeout(a);a=setTimeout(c,b)}})();function generatorID(d,g){if(DEBUG){console.log("function:generatorID")}var b=[],e="i",a=1000,f=9999,c=Math.floor(Math.random()*(f-a+1))+a;e+=$.now()+String(c);if(d){b.push(d)}b.push(e);if(g){b.push(g)}return validatorID(b)}function validatorID(a){if($.type(a)==="array"){a=a.join("_")}if(DEBUG){console.log("function:validatorID")}return a.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){if(DEBUG){console.log("function:handlerShowAlert")}b=b||5000;console.log(c);if(!a){a="alert-danger"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"reportapi.get_scheme"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON(a),language:window.LANGUAGE_CODE},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-danger")}}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){redirect=function(){location=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location)};if(h.message){handlerShowAlert(h.message,"alert-danger",redirect)}else{redirect()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-danger")}else{if(DEBUG){o=new Object;$.extend(true,o,h.data);console.log($.toJSON(h.message))}return f(h,g,i)}}});return e}function handlerCreateReport(a){if(DEBUG){console.log("function:handlerCreateReport")}$(".action-preview, .action-remove, .action-download").prop("disabled",true);window.REPORT.id=null;window.REPORT.process_filters={};$.each(window.REPORT.filters,function(c,d){if(d.condition||d.value!=null){window.REPORT.process_filters[d.name]={condition:d.condition,value:d.value}}});args={method:"reportapi.document_create",section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,force:a,};cb=function(d,c,e){};var b=jsonAPI(args,cb,null,false,window.REPORT.timeout);handlerStartProgress();return b}function eventCreateReport(a){if(DEBUG){console.log("function:eventCreateReport")}handlerCreateReport()}function eventRecreateReport(a){if(DEBUG){console.log("function:eventRecreateReport")}handlerCreateReport(true)}function handlerCheckProcess(){if(DEBUG){console.log("function:handlerCheckProcess")}args={method:"reportapi.document_info",id:window.REPORT.id||null,section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,};cb=function(c,b,d){$obj=$(".progress .progress-bar");max=Number($obj.attr("aria-valuemax"));now=Number($obj.attr("aria-valuetransitiongoal"));window.REPORT.id=c.data.id;window.REPORT.timeout=c.data.timeout;if(c.data.end){clearInterval(window.REPORT.process);window.REPORT.process=undefined;$obj.attr("aria-valuetransitiongoal",max).progressbar();url=c.data.url+window.REPORT.format.toLowerCase()+"/";$(".action-preview").attr("onClick","handlerShowDocument('"+c.data.url+"', 'document-"+c.data.id+"')").prop("disabled",false).show();if(c.data.error){$(".action-download").prop("disabled",true).hide();$(".action-remove").attr("onClick","handlerRemoveDocument("+c.data.id+")").prop("disabled",true).show();if(c.data.has_remove){$(".action-remove").prop("disabled",false)}$(".action-preview").removeClass("btn-default").addClass("btn-warning").find(".fa").removeClass("fa-search").addClass("fa-bug")}else{$(".action-remove").prop("disabled",true).hide();$(".action-download").attr("href",url).prop("disabled",false).show();$(".action-preview").removeClass("btn-warning").addClass("btn-default").find(".fa").removeClass("fa-bug").addClass("fa-search")}$(".progress").removeClass("progress-striped").removeClass("active").hide();$obj.attr("aria-valuetransitiongoal",0).progressbar();if(window.REPORT.create_force){$(".action-create-report:visible").hide();$(".action-recreate-report:hidden").show()}else{$(".action-create-report").prop("disabled",true)}}else{if(now>=max){$(".progress").addClass("progress-striped").addClass("active")}else{$obj.attr("aria-valuetransitiongoal",TIMEOUT_PROGRESS+now).progressbar()}}};var a=jsonAPI(args,cb);return a}function handlerStartProgress(){if(DEBUG){console.log("function:handlerStartProgress")}$(".action-create-report").prop("disabled",true);$(".progress .progress-bar").attr("aria-valuemax",window.REPORT.timeout||TIMEOUT_PROGRESS).attr("aria-valuetransitiongoal",1).progressbar();$(".progress").show();window.REPORT.process=setInterval(function(){handlerCheckProcess()},window.TIMEOUT_PROGRESS)}function handlerRemoveDocument(c){if(DEBUG){console.log("function:handlerRemoveDocument")}if(c){var a={method:"reportapi.document_delete",id:c,},b=function(){$(".action-preview, .action-remove, .action-download").prop("disabled",true).hide();$("#thumbnail-document-"+c).remove()};new jsonAPI(a,b)}}function eventRemoveDocument(a){if(DEBUG){console.log("function:eventRemoveDocument")}var b=null;handlerRemoveDocument(b)}function handlerSetSelectizers(a){if(DEBUG){console.log("function:handlerSetSelectizers")}a=a||$("body");$.each(a.find('select[data-type="object"]'),function(c,b){if(b.name){var d=window.REPORT.filters[b.name],e=d.unicode_key||"__unicode__";$(b).selectize({valueField:"pk",labelField:e,searchField:d.fields_search||e,create:false,options:d.options,maxItems:(d.condition=="range")?2:undefined,render:{option:function(g,f){return'<div><span class="pull-right"> #'+f(g.pk)+"</span><span>"+f(g[e])+"</span></div>"}},load:function(h,j){if(!h.length){return j()}if(d.search_on_date){var f=moment(h);if(f.invalidAt()>-1||h.length<10){return j()}}var g={method:"reportapi.object_search",section:window.REPORT.section||null,name:window.REPORT.name,filter_name:filter_name,query:h,},i=function(k){j(k.data.object_list)};new jsonAPI(g,i)},onChange:function(f){if(d.condition=="range"&&f.length!=2){d.value=null}else{d.value=(f=="")?null:f}handlerAfterChanges()},onClear:function(){d.value=null;handlerAfterChanges()}})}});other=a.find('select[data-type="choice"], select[data-type="month"], select[data-type="weekday"]');$.each(other,function(c,b){if(b.name){var d=window.REPORT.filters[b.name];$(b).selectize({options:d.options,valueField:"value",labelField:"label",searchField:"label",create:false,maxItems:(d.condition=="range")?2:undefined,onChange:function(e){if(d.condition=="range"&&e.length!=2){d.value=null}else{d.value=(e=="")?null:e}handlerAfterChanges()},onClear:function(){d.value=null;handlerAfterChanges()}})}})}function handlerMaskInputs(a){if(DEBUG){console.log("function:handlerMaskInputs")}a=a||$("body");$.mask.definitions["1"]="[0-1]";$.mask.definitions["2"]="[0-2]";$.mask.definitions["3"]="[0-3]";$.mask.definitions["5"]="[0-5]";$.each(a.find("[data-mask]"),function(b,c){$item=$(c);data=$(c).data();$item.mask(data.mask,{completed:function(){filter=REPORT.filters[this.context.name];filter.value=this.val();if(filter.condition=="range"){filter.value=filter.value.split(RANGE_SPLIT)}}})});return true}function handlerCheckRequiredValue(){if(DEBUG){console.log("function:handlerCheckRequiredValue")}completed=true;$.each(REPORT.filters,function(a,b){if((b.required)&&(b.value===null||b.value===undefined)){completed=false}});if(completed){$(".action-create-report").prop("disabled",false)}else{$(".action-create-report").prop("disabled",true)}return completed}function handlerAfterChanges(){if(DEBUG){console.log("function:handlerAfterChanges")}if(window.REPORT.process){clearInterval(window.REPORT.process);window.REPORT.id=null;window.REPORT.process=null}$(".progress:visible").hide();$(".progress .progress-bar").attr("aria-valuetransitiongoal",0).progressbar();$(".action-preview:visible").hide();$(".action-download:visible").hide();$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();$(".action-preview, .action-remove, .action-download").prop("disabled",true).hide();handlerCheckRequiredValue()}function eventChangeValue(a){if(DEBUG){console.log("function:eventChangeValue")}value=$(a.target).val();filter=REPORT.filters[a.target.name];if(a.target.type=="checkbox"){filter.value=a.target.checked}else{if($(a.target).attr("data-mask")!==undefined){filter.value=value?filter.value:null}else{filter.value=value||null}}handlerAfterChanges()}function eventConditionChange(a){if(DEBUG){console.log("function:eventConditionChange")}filter_name=$(a.target).data()["name"];filter=REPORT.filters[filter_name];filter.condition=a.target.value||null;if(filter.condition in {isnull:0,empty:0}){filter.value=false}else{if(!filter.condition||filter.condition in {range:0,"in":0}||filter.type=="object"){filter.value=null}else{filter.value=$("#value-"+filter_name).val()||null}}html=TEMPLATES.filter({data:filter});$("#valuebox-"+filter_name).html(html);handlerSetSelectizers($("#valuebox-"+filter_name));handlerMaskInputs($("#valuebox-"+filter_name));handlerAfterChanges();return true}function keyDownIsControl(a){if(DEBUG){console.log("function:keyDownIsControl")}if((a.which==8)||(a.which==9)||(a.which==13)||(a.which==27)||(a.which>=33&&a.which<=46)||(a.which>=112&&a.which<=145)){return true}return false}function eventKeyDownOnDateTime(a){if(DEBUG){console.log("function:eventKeyDownOnDateTime")}prepare=function(b){value=b.target.value||""};if(keyDownIsControl(a)){return true}else{if(a.which>=48&&a.which<=57){prepare(a);return true}}return false}function eventKeyDownOnNumber(a){adddot=function(b){value=b.target.value||"";if(value.length<1){b.target.value="0."}else{if(value.indexOf(".")<0){b.target.value=b.target.value+"."}}};if((a.which>=48&&a.which<=57)||keyDownIsControl(a)){return true}else{if(a.which==188||a.which==190){adddot(a);return false}}return false}function handlerShowDocument(a,b){if(DEBUG){console.log("function:handlerShowDocument")}var c=window.open(a,b,"height=500,width=800,resizable=yes,scrollbars=yes");c.focus()}function handlerShowAdditionalFilters(){if(DEBUG){console.log("function:handlerShowAdditionalFilters")}$(".additional-filter").show();$("button.action-hide-additional").show();$("button.action-show-additional").hide();return true}function handlerHideAdditionalFilters(){if(DEBUG){console.log("function:handlerHideAdditionalFilters")}$(".additional-filter").hide();$("button.action-hide-additional").hide();$("button.action-show-additional").show();return true}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.filter=_.template($("#underscore-filter").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("change",'select[id^="condition-"]',eventConditionChange);$("body").on("keydown",'input[data-validate="number"]',eventKeyDownOnNumber);$("body").on("change",'input[id^="value-"]',eventChangeValue);$("body").on("click",".action-hide-additional",handlerHideAdditionalFilters);$("body").on("click",".action-show-additional",handlerShowAdditionalFilters);$("body").on("click",".action-create-report",eventCreateReport);$("body").on("click",".action-recreate-report",eventRecreateReport);return true}function datePreParser(b){var c=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:[ T](\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/;var a=c.exec(b);if(!a){return null}return{dict:{year:Number(a[1]),month:a[2]?Number(a[2]):null,day:a[3]?Number(a[3]):null,hour:a[4]?Number(a[4]):null,minute:a[5]?Number(a[5]):null,second:a[6]?Number(a[6]):null,millisecond:a[7]?Number(a[7]):null,UTC:a[8]?true:false,TZsign:(a[9]=="-")?-1:1,TZhour:a[10]?Number(a[10]):null,TZminute:a[11]?Number(a[11]):null,},list:a,}}function dateParser(c,d){var f=datePreParser(c);if(!f){return null}var e=f.dict,a=f.list,b=(new Date()).getTimezoneOffset();tzoffset=0,minute=0;if(e.UTC){minute-=b}else{if(a[10]||a[11]){tzoffset=e.TZsign*(e.TZhour*60+e.TZminute)*-1;minute-=b-tzoffset}else{if(!d){minute-=b-(window.SERVER_TZ_OFFSET||0)}}}return new Date(e.year,(e.month?(e.month-1):0),e.day,e.hour,minute,e.second,e.millisecond)}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("alert").alert();a(".dropdown-toggle").dropdown();handlerBindinds();handlerMaskInputs();handlerHideAdditionalFilters()});