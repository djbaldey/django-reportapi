var TIMEOUT_PROGRESS=1000,SERVER_TZ_OFFSET=window.SERVER_TZ_OFFSET||-240;window.TEMPLATES={};_.mixin(_.str.exports());delay=(function(){var a=0;return function(c,b){if(DEBUG){console.log("function:delay "+b)}clearTimeout(a);a=setTimeout(c,b)}})();function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){if(DEBUG){console.log("function:handlerShowAlert")}b=b||5000;console.log(c);if(!a){a="alert-danger"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"reportapi.get_scheme"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON(a),language:window.LANGUAGE_CODE},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-danger")}}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){redirect=function(){location=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location)};if(h.message){handlerShowAlert(h.message,"alert-danger",redirect)}else{redirect()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-danger");clearInterval(window.REPORT.process);window.REPORT.process=undefined;$(".progress .progress-bar").removeClass("progress-striped active");handlerSetProgress(0)}else{if(DEBUG){o=new Object;$.extend(true,o,h.data);console.log($.toJSON(h.message))}return f(h,g,i)}}});return e}function handlerCreateReport(a){if(DEBUG){console.log("function:handlerCreateReport")}$(".action-create-report, .action-recreate-report, .action-preview, .action-remove").attr("disabled","disabled");$("#view-document-place").hide();window.REPORT.id=null;window.REPORT.process_filters={};$.each(window.REPORT.filters,function(c,d){if(d.condition||d.value!=null){window.REPORT.process_filters[d.name]={condition:d.condition,value:d.value}}});args={method:"reportapi.document_create",section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,force:a,};cb=function(d,c,e){};var b=jsonAPI(args,cb,null,false,window.REPORT.timeout);handlerStartProgress();return b}function eventCreateReport(a){if(DEBUG){console.log("function:eventCreateReport")}handlerCreateReport()}function eventRecreateReport(a){if(DEBUG){console.log("function:eventRecreateReport")}handlerCreateReport(true)}function handlerCheckProcess(){if(DEBUG){console.log("function:handlerCheckProcess")}args={method:"reportapi.document_info",id:window.REPORT.id||null,section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,};cb=function(e,c,g){var f=$(".progress .progress-bar"),b=Number(f.attr("aria-valuemax")),d=Number(f.attr("aria-valuenow"));window.REPORT.id=e.data.id;window.REPORT.timeout=e.data.timeout;if(e.data.end){clearInterval(window.REPORT.process);window.REPORT.process=undefined;handlerSetProgress(b);$(".action-preview").attr("onclick","handlerShowDocument('"+e.data.url+"', 'document-"+e.data.id+"')").prop("disabled",false).removeAttr("disabled");if(e.data.error){$(".action-preview").removeClass("btn-default btn-success").addClass("btn-warning").find(".fa").removeClass("fa-search").addClass("fa-bug")}else{$(".action-preview").removeClass("btn-warning").addClass("btn-default").find(".fa").removeClass("fa-bug").addClass("fa-search")}if(e.data.has_remove){$(".action-remove").attr("onclick","handlerRemoveDocument("+e.data.id+")").prop("disabled",false).removeAttr("disabled")}else{$(".action-remove").removeAttr("onclick").prop("disabled",true).attr("disabled","disabled")}f.removeClass("progress-striped active");$(".action-recreate-report").prop("disabled",false).removeAttr("disabled");if(window.REPORT.create_force){$(".action-create-report:visible").hide();$(".action-recreate-report:hidden").show()}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}}else{if(d>=b){f.addClass("progress-striped active")}else{console.log(TIMEOUT_PROGRESS+d);handlerSetProgress(TIMEOUT_PROGRESS+d)}}};var a=jsonAPI(args,cb);return a}function handlerStartProgress(){if(DEBUG){console.log("function:handlerStartProgress")}$(".action-create-report").prop("disabled",true);$(".progress .progress-bar").attr("aria-valuemax",window.REPORT.timeout||TIMEOUT_PROGRESS).attr("aria-valuenow",0).css("width","0%");window.REPORT.process=setInterval(function(){handlerCheckProcess()},window.TIMEOUT_PROGRESS)}function handlerRemoveDocument(d,b){if(DEBUG){console.log("function:handlerRemoveDocument")}if(d){var a={method:"reportapi.document_delete",id:d,},c=function(){$("#div-document-"+d).remove();$("#view-document-place").hide();handlerAfterChanges();if(b){window.location.reload()}};new jsonAPI(a,c)}}function eventRemoveDocument(a){if(DEBUG){console.log("function:eventRemoveDocument")}var b=null;handlerRemoveDocument(b)}function handlerSetSelectizers(a){if(DEBUG){console.log("function:handlerSetSelectizers")}a=a||$("body");$.each(a.find('select[data-type="object"]'),function(c,b){if(b.name){var d=window.REPORT.filters[b.name],e=d.unicode_key||"__unicode__";$(b).selectize({valueField:"pk",labelField:e,searchField:d.fields_search||e,create:false,options:d.options,maxItems:(d.condition=="range")?2:undefined,render:{option:function(g,f){return'<div><span class="pull-right"> #'+f(g.pk)+"</span><span>"+f(g[e])+"</span></div>"}},load:function(h,j){if(!h.length){return j()}if(d.search_on_date){var f=moment(h);if(f.invalidAt()>-1||h.length<10){return j()}}var g={method:"reportapi.object_search",section:window.REPORT.section||null,name:window.REPORT.name,filter_name:filter_name,query:h,},i=function(k){j(k.data.object_list)};new jsonAPI(g,i)},onChange:function(f){if(d.condition=="range"&&f.length!=2){d.value=null}else{d.value=(f=="")?null:f}handlerAfterChanges()},onClear:function(){d.value=null;handlerAfterChanges()}})}});other=a.find('select[data-type="choice"],                      select[data-type="month"],                      select[data-type="weekday"],                      select[data-type="period"]');$.each(other,function(c,b){if(b.name){var d=window.REPORT.filters[b.name];$(b).selectize({options:d.options,valueField:"value",labelField:"label",searchField:"label",create:false,maxItems:(d.condition=="range")?2:undefined,onChange:function(e){if(d.condition=="range"&&e.length!=2){d.value=null}else{d.value=(e=="")?null:e}handlerAfterChanges()},onClear:function(){d.value=null;handlerAfterChanges()}})}})}function handlerMaskInputs(a){if(DEBUG){console.log("function:handlerMaskInputs")}a=a||$("body");$.mask.definitions["1"]="[0-1]";$.mask.definitions["2"]="[0-2]";$.mask.definitions["3"]="[0-3]";$.mask.definitions["5"]="[0-5]";$.each(a.find("[data-mask]"),function(b,c){$item=$(c);data=$(c).data();$item.mask(data.mask,{completed:function(){filter=REPORT.filters[this.context.name];filter.value=this.val();if(filter.condition=="range"){filter.value=filter.value.split(RANGE_SPLIT)}}})});return true}function handlerCheckRequiredValue(){if(DEBUG){console.log("function:handlerCheckRequiredValue")}completed=true;$.each(REPORT.filters,function(a,b){if((b.required)&&(b.value===null||b.value===undefined)){completed=false}});if(completed){$(".action-create-report").prop("disabled",false).removeAttr("disabled")}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}return completed}function handlerAfterChanges(){if(DEBUG){console.log("function:handlerAfterChanges")}if(window.REPORT.process){clearInterval(window.REPORT.process);window.REPORT.id=null;window.REPORT.process=null}handlerSetProgress(0);$(".action-create-report, .action-preview, .action-remove").attr("disabled","disabled");$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();handlerCheckRequiredValue()}function eventChangeValue(a){if(DEBUG){console.log("function:eventChangeValue")}value=$(a.target).val();filter=REPORT.filters[a.target.name];if(a.target.type=="checkbox"){filter.value=a.target.checked}else{filter.value=value||null}handlerAfterChanges()}function eventConditionChange(a){if(DEBUG){console.log("function:eventConditionChange")}filter_name=$(a.target).data()["name"];filter=REPORT.filters[filter_name];filter.condition=a.target.value||null;if(filter.condition in {isnull:0,empty:0}){filter.value=false}else{if(!filter.condition||filter.condition in {range:0,"in":0}||filter.type=="object"){filter.value=null}else{filter.value=$("#value-"+filter_name).val()||null}}html=TEMPLATES.filter({data:filter});$("#valuebox-"+filter_name).html(html);handlerSetSelectizers($("#valuebox-"+filter_name));handlerMaskInputs($("#valuebox-"+filter_name));handlerAfterChanges();return true}function keyDownIsControl(a){if(DEBUG){console.log("function:keyDownIsControl")}if((a.which==8)||(a.which==9)||(a.which==13)||(a.which==27)||(a.which>=33&&a.which<=46)||(a.which>=112&&a.which<=145)){return true}return false}function eventKeyDownOnDateTime(a){if(DEBUG){console.log("function:eventKeyDownOnDateTime")}prepare=function(b){value=b.target.value||""};if(keyDownIsControl(a)){return true}else{if(a.which>=48&&a.which<=57){prepare(a);return true}}return false}function eventKeyDownOnNumber(a){adddot=function(b){value=b.target.value||"";if(value.length<1){b.target.value="0."}else{if(value.indexOf(".")<0){b.target.value=b.target.value+"."}}};if((a.which>=48&&a.which<=57)||keyDownIsControl(a)){return true}else{if(a.which==188||a.which==190){adddot(a);return false}}return false}function handlerSetProgress(b){if(DEBUG){console.log("function:handlerSetProgress")}var d=$(".progress .progress-bar"),a=Number(d.attr("aria-valuemax"))||100,b=b||0,c=(b/a)*100;c=c>100?100:c;d.attr("aria-valuenow",b).css("width",c+"%")}function handlerShowDocument(a,c,b){if(DEBUG){console.log("function:handlerShowDocument")}if(b){var e=window.open(a,c,"height=500,width=800,resizable=yes,scrollbars=yes");e.focus()}else{var f=$("#view-document-place"),d='<iframe class="embed-responsive-item" src="'+a+'" allowfullscreen webkitallowfullscreen></iframe>';if(f.size()==0){$("#view-"+c).toggle();$("#view-"+c+":visible .embed-responsive").html(d)}else{f.show().find(".embed-responsive").html(d)}}}function handlerShowAdditionalFilters(){if(DEBUG){console.log("function:handlerShowAdditionalFilters")}$(".additional-filter").show();$(".action-hide-additional").show();$(".action-show-additional").hide();return true}function handlerHideAdditionalFilters(){if(DEBUG){console.log("function:handlerHideAdditionalFilters")}$(".additional-filter").hide();$(".action-hide-additional").hide();$(".action-show-additional").show();return true}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.filter=_.template($("#underscore-filter").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("change",'select[id^="condition-"]',eventConditionChange);$("body").on("keydown",'input[data-validate="number"]',eventKeyDownOnNumber);$("body").on("change",'input[id^="value-"]',eventChangeValue);$("body").on("click",".action-hide-additional",handlerHideAdditionalFilters);$("body").on("click",".action-show-additional",handlerShowAdditionalFilters);$("body").on("click",".action-create-report",eventCreateReport);$("body").on("click",".action-recreate-report",eventRecreateReport);return true}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("alert").alert();a(".dropdown-toggle").dropdown();handlerBindinds();handlerMaskInputs();handlerHideAdditionalFilters()});